<!DOCTYPE html>
<html>
<head>
    <title>Chat Application</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .chat-container {
            max-width: 800px;
            margin: 30px auto;
        }
        .chat-messages {
            height: 400px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 15px;
            margin-bottom: 20px;
        }
        .message {
            margin-bottom: 10px;
            padding: 8px;
            border-radius: 5px;
        }
        .received {
            background-color: #f1f0f0;
        }
        .sent {
            background-color: #dcf8c6;
            margin-left: auto;
            margin-right: 0;
            max-width: 80%;
        }
        .online-users {
            height: 400px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 15px;
        }
        .timestamp {
            font-size: 0.8em;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container chat-container">
        <div class="row">
            <div class="col-md-9">
                <h2>Chat Room</h2>
                <div class="chat-messages" id="chat-messages"></div>
                <div class="input-group">
                    <input type="text" id="message" class="form-control" placeholder="Type your message...">
                    <button class="btn btn-primary" onclick="sendMessage()">Send</button>
                </div>
            </div>
            <div class="col-md-3">
                <h3>Online Users</h3>
                <div class="online-users" id="online-users"></div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.0/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <script>
        let stompClient = null;
        const userId = generateUserId(); // In real app, this would come from authentication
        const username = 'User-' + userId.substring(0, 4); // Simple username generation

        function connect() {
            const socket = new SockJS('/ws');
            stompClient = Stomp.over(socket);
            
            stompClient.connect({
                userId: userId,
                username: username
            }, function(frame) {
                console.log('Connected: ' + frame);
                
                // Subscribe to public messages
                stompClient.subscribe('/topic/public', onMessageReceived);
                
                // Subscribe to private messages
                stompClient.subscribe('/user/' + userId + '/topic/messages', onPrivateMessageReceived);
                
                // Subscribe to user status updates
                stompClient.subscribe('/topic/user-status', onUserStatusReceived);
                
                // Send join message
                sendJoinMessage();
                
                // Load online users
                loadOnlineUsers();
            });
        }

        function sendMessage() {
            const messageInput = document.getElementById('message');
            const messageContent = messageInput.value.trim();
            
            if(messageContent && stompClient) {
                const chatMessage = {
                    senderId: userId,
                    senderName: username,
                    content: messageContent,
                    type: 'CHAT',
                    timestamp: new Date()
                };
                
                stompClient.send("/app/chat.sendMessage", {}, JSON.stringify(chatMessage));
                messageInput.value = '';
            }
        }

        function onMessageReceived(payload) {
            const message = JSON.parse(payload.body);
            displayMessage(message);
        }

        function onPrivateMessageReceived(payload) {
            const message = JSON.parse(payload.body);
            displayMessage(message, true);
        }

        function onUserStatusReceived(payload) {
            const status = JSON.parse(payload.body);
            updateUserStatus(status);
        }

        function displayMessage(message, isPrivate = false) {
            const messagesContainer = document.getElementById('chat-messages');
            const messageElement = document.createElement('div');
            
            const isOwnMessage = message.senderId === userId;
            messageElement.classList.add('message', isOwnMessage ? 'sent' : 'received');
            
            let content = '';
            if (message.type === 'JOIN') {
                content = `<strong>${message.senderName}</strong> joined the chat`;
            } else if (message.type === 'LEAVE') {
                content = `<strong>${message.senderName}</strong> left the chat`;
            } else {
                content = `<strong>${message.senderName}</strong>: ${message.content}<br>
                          <span class="timestamp">${new Date(message.timestamp).toLocaleString()}</span>`;
            }
            
            messageElement.innerHTML = content;
            messagesContainer.appendChild(messageElement);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function updateUserStatus(status) {
            const usersContainer = document.getElementById('online-users');
            const userElement = document.createElement('div');
            userElement.innerHTML = `${status.userName} - ${status.status.toLowerCase()}`;
            usersContainer.appendChild(userElement);
        }

        function loadOnlineUsers() {
            fetch('/api/public/chat/online-users')
                .then(response => response.json())
                .then(users => {
                    const usersContainer = document.getElementById('online-users');
                    usersContainer.innerHTML = '';
                    users.forEach(user => {
                        updateUserStatus(user);
                    });
                })
                .catch(error => console.error('Error loading online users:', error));
        }

        function sendJoinMessage() {
            if(stompClient) {
                const joinMessage = {
                    senderId: userId,
                    senderName: username,
                    type: 'JOIN',
                    timestamp: new Date()
                };
                stompClient.send("/app/chat.addUser", {}, JSON.stringify(joinMessage));
            }
        }

        function generateUserId() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                const r = Math.random() * 16 | 0;
                const v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        // Add event listener for enter key
        document.getElementById('message').addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        });

        // Connect when page loads
        connect();
    </script>
</body>
</html>
